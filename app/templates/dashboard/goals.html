{% extends 'dashboard/layout.html' %}

{% set active_page = 'goals' %}

{% block dashboard_title %}Your Goals{% endblock %}


{% block dashboard_content %}

<!-- Current Goals -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Current Goals</h6>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGoalModal">
                    <i class="fas fa-plus"></i> New Goal
                </button>
            </div>
            <div class="card-body">
                {% if goals %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Activity</th>
                                <th>Goal Type</th>
                                <th>Target</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="goals-table-body">
                            {% for goal in goals %}
                            <tr id="goal-row-{{ goal.id }}">
                                <td>{{ goal.activity_type.name }}</td>
                                <td>{{ goal.goal_type|capitalize }}</td>
                                <td>{{ goal.target_value }} 
                                    {% if goal.goal_type == 'distance' %}km
                                    {% elif goal.goal_type == 'duration' %}minutes
                                    {% elif goal.goal_type == 'reps' %}repetitions
                                    {% elif goal.goal_type == 'calories' %}calories
                                    {% endif %}
                                </td>
                                <td>{{ goal.start_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ goal.end_date.strftime('%Y-%m-%d') if goal.end_date else 'Ongoing' }}</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar {{ 'bg-success' if goal.is_completed else '' }}" 
                                             role="progressbar" 
                                             style="width: {{ goal.get_progress().percentage }}%" 
                                             aria-valuenow="{{ goal.get_progress().percentage }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ goal.get_progress().percentage|int }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info edit-goal-btn" 
                                            data-goal-id="{{ goal.id }}"
                                            data-activity-type="{{ goal.activity_type.id }}"
                                            data-goal-type="{{ goal.goal_type }}"
                                            data-target-value="{{ goal.target_value }}"
                                            data-end-date="{{ goal.end_date.strftime('%Y-%m-%d') if goal.end_date else '' }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-goal-btn" data-goal-id="{{ goal.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <p class="mb-0">You don't have any goals yet. Click the 'New Goal' button to create one.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Goal Insights -->
<div class="row">
    <!-- Goal Distribution -->
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Goals by Activity Type</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie">
                    <canvas id="goalDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Goal Completion Rate -->
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Goal Completion History</h6>
            </div>
            <div class="card-body">
                <div class="chart-bar">
                    <canvas id="goalCompletionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Goal Modal -->
<div class="modal fade" id="createGoalModal" tabindex="-1" aria-labelledby="createGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createGoalModalLabel">Create New Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createGoalForm">
                    <div class="mb-3">
                        <label for="activityType" class="form-label">Activity Type</label>
                        <select class="form-select" id="activityType" required>
                            <option value="" selected disabled>Select activity type</option>
                            {% for activity_type in activity_types %}
                            <option value="{{ activity_type.id }}">{{ activity_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="goalType" class="form-label">Goal Type</label>
                        <select class="form-select" id="goalType" required>
                            <option value="" selected disabled>Select goal type</option>
                            <option value="distance">Distance</option>
                            <option value="duration">Duration</option>
                            <option value="reps">Repetitions</option>
                            <option value="calories">Calories</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="targetValue" class="form-label">Target Value</label>
                        <input type="number" class="form-control" id="targetValue" required min="1" step="0.01">
                        <div class="form-text" id="targetValueHelp">
                            Enter the target value (e.g., 10 km, 30 minutes, 100 reps, 500 calories)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date (Optional)</label>
                        <input type="date" class="form-control" id="endDate">
                        <div class="form-text">
                            If not specified, this will be an ongoing goal
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGoalBtn">Create Goal</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Goal Modal -->
<div class="modal fade" id="editGoalModal" tabindex="-1" aria-labelledby="editGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGoalModalLabel">Edit Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGoalForm">
                    <input type="hidden" id="editGoalId">
                    <div class="mb-3">
                        <label for="editActivityType" class="form-label">Activity Type</label>
                        <select class="form-select" id="editActivityType" disabled>
                            {% for activity_type in activity_types %}
                            <option value="{{ activity_type.id }}">{{ activity_type.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Activity type cannot be changed once a goal is created
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editGoalType" class="form-label">Goal Type</label>
                        <select class="form-select" id="editGoalType" disabled>
                            <option value="distance">Distance</option>
                            <option value="duration">Duration</option>
                            <option value="reps">Repetitions</option>
                            <option value="calories">Calories</option>
                        </select>
                        <div class="form-text">
                            Goal type cannot be changed once a goal is created
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editTargetValue" class="form-label">Target Value</label>
                        <input type="number" class="form-control" id="editTargetValue" required min="1" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="editEndDate" class="form-label">End Date (Optional)</label>
                        <input type="date" class="form-control" id="editEndDate">
                        <div class="form-text">
                            If not specified, this will be an ongoing goal
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editIsCompleted">
                        <label class="form-check-label" for="editIsCompleted">Mark as completed</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateGoalBtn">Update Goal</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Goal Confirmation Modal -->
<div class="modal fade" id="deleteGoalModal" tabindex="-1" aria-labelledby="deleteGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteGoalModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this goal? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Goal</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Global variables
    let deleteGoalId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Set up chart data if there are goals
        {% if goals %}
            setupGoalCharts();
        {% endif %}
        
        // Set up event listeners
        document.getElementById('saveGoalBtn').addEventListener('click', createGoal);
        document.getElementById('updateGoalBtn').addEventListener('click', updateGoal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteGoal);
        
        // Set up edit buttons
        setupEditButtons();
        setupDeleteButtons();
    });
    
    function setupEditButtons() {
        const editButtons = document.querySelectorAll('.edit-goal-btn');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const goalId = this.getAttribute('data-goal-id');
                const activityType = this.getAttribute('data-activity-type');
                const goalType = this.getAttribute('data-goal-type');
                const targetValue = this.getAttribute('data-target-value');
                const endDate = this.getAttribute('data-end-date');
                
                // Populate the edit modal
                document.getElementById('editGoalId').value = goalId;
                document.getElementById('editActivityType').value = activityType;
                document.getElementById('editGoalType').value = goalType;
                document.getElementById('editTargetValue').value = targetValue;
                document.getElementById('editEndDate').value = endDate;
                
                // Show the modal
                const editModal = new bootstrap.Modal(document.getElementById('editGoalModal'));
                editModal.show();
            });
        });
    }
    
    function setupDeleteButtons() {
        const deleteButtons = document.querySelectorAll('.delete-goal-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                deleteGoalId = this.getAttribute('data-goal-id');
                
                // Show the confirmation modal
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteGoalModal'));
                deleteModal.show();
            });
        });
    }
    
    async function createGoal() {
        const activityTypeId = document.getElementById('activityType').value;
        const goalType = document.getElementById('goalType').value;
        const targetValue = document.getElementById('targetValue').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!activityTypeId || !goalType || !targetValue) {
            alert('Please fill in all required fields');
            return;
        }
        
        const goalData = {
            activity_type_id: parseInt(activityTypeId),
            goal_type: goalType,
            target_value: parseFloat(targetValue),
            end_date: endDate || null
        };
        
        try {
            const response = await fetch('/api/goals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(goalData)
            });
            
            if (response.ok) {
                // Reload the page to show the new goal
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error creating goal: ${error.error}`);
            }
        } catch (error) {
            console.error('Error creating goal:', error);
            alert('Error creating goal. Please try again.');
        }
    }
    
    async function updateGoal() {
        const goalId = document.getElementById('editGoalId').value;
        const targetValue = document.getElementById('editTargetValue').value;
        const endDate = document.getElementById('editEndDate').value;
        const isCompleted = document.getElementById('editIsCompleted').checked;
        
        if (!targetValue) {
            alert('Please provide a target value');
            return;
        }
        
        const goalData = {
            target_value: parseFloat(targetValue),
            end_date: endDate || null,
            is_completed: isCompleted
        };
        
        try {
            const response = await fetch(`/api/goals/${goalId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(goalData)
            });
            
            if (response.ok) {
                // Reload the page to show the updated goal
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error updating goal: ${error.error}`);
            }
        } catch (error) {
            console.error('Error updating goal:', error);
            alert('Error updating goal. Please try again.');
        }
    }
    
    async function deleteGoal() {
        if (!deleteGoalId) return;
        
        try {
            const response = await fetch(`/api/goals/${deleteGoalId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Reload the page to update the goals list
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error deleting goal: ${error.error}`);
            }
        } catch (error) {
            console.error('Error deleting goal:', error);
            alert('Error deleting goal. Please try again.');
        }
    }
    
    function setupGoalCharts() {
        // Set up the goal distribution chart
        const distributionCtx = document.getElementById('goalDistributionChart').getContext('2d');
        
        // Extract data for charts
        const goalsByActivityType = {};
        const goalCompletionData = {
            completed: 0,
            inProgress: 0
        };
        
        {% for goal in goals %}
            // Add to the activity type count
            const activityName = "{{ goal.activity_type.name }}";
            if (goalsByActivityType[activityName]) {
                goalsByActivityType[activityName]++;
            } else {
                goalsByActivityType[activityName] = 1;
            }
            
            // Add to the completion data
            if ({{ goal.is_completed|lower }}) {
                goalCompletionData.completed++;
            } else {
                goalCompletionData.inProgress++;
            }
        {% endfor %}
        
        // Create pie chart for goal distribution
        new Chart(distributionCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(goalsByActivityType),
                datasets: [{
                    data: Object.values(goalsByActivityType),
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                        '#858796', '#5a5c69', '#2e59d9', '#17a673', '#2c9faf'
                    ],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Create bar chart for goal completion
        const completionCtx = document.getElementById('goalCompletionChart').getContext('2d');
        new Chart(completionCtx, {
            type: 'bar',
            data: {
                labels: ['Goal Status'],
                datasets: [
                    {
                        label: 'Completed',
                        data: [goalCompletionData.completed],
                        backgroundColor: '#1cc88a'
                    },
                    {
                        label: 'In Progress',
                        data: [goalCompletionData.inProgress],
                        backgroundColor: '#4e73df'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}