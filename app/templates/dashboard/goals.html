{% extends 'dashboard/layout.html' %}

{% set active_page = 'goals' %}

{% block dashboard_title %}Your Goals{% endblock %}

{% block dashboard_content %}


<!-- Current Goals -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center bg-gradient">
                <h6 class="m-0 fw-bold text-white"><i class="fas fa-history me-2"></i>Current Activity Sessions</h6>
                <button type="button" class="btn btn-light pulse-button" data-bs-toggle="modal" data-bs-target="#createGoalModal">
                    <i class="fas fa-plus me-2 text-primary"></i> New Session
                </button>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label for="goalSelector" class="form-label text-light">Select Goal</label>
                    <select class="form-select" id="goalSelector">
                        <option value="" selected disabled>Choose a goal</option>
                        {% for goal in goals %}
                        <option value="goal-{{ goal.id }}">Goal #{{ goal.id }} - {{ goal.goal_type|title }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button id="deleteAllGoalsBtn" class="btn btn-danger">
                Delete All Goals
            </button>
            {% if sessions|length == 0 %}
            <div class="text-center py-5 empty-state">
                <i class="fas fa-dumbbell fa-4x mb-4 text-secondary opacity-50"></i>
                <h5 class="text-secondary">No Activity Sessions Yet</h5>
                <p class="mb-4 text-muted">Track your workouts by creating a new session.</p>
                <button type="button" class="btn btn-primary pulse-button" data-bs-toggle="modal" data-bs-target="#createSessionModal">
                    <i class="fas fa-plus me-2"></i> Create Your First Session
                </button>
            </div>
        {% else %}
            {% for goal_type, sessions in grouped_sessions.items() %}
            <div class="goal-type-container mb-4">
                <div class="goal-type-header d-flex justify-content-between align-items-center">
                    <h4 class="goal-title mb-0">
                        {% if goal_type == 'weightloss' %}
                            <i class="fas fa-weight scale-in-center text-danger me-2"></i>
                        {% elif goal_type == 'weightgain' %}
                            <i class="fas fa-dumbbell scale-in-center text-success me-2"></i>
                        {% elif goal_type == 'strength' %}
                            <i class="fas fa-fist-raised scale-in-center text-warning me-2"></i>
                        {% elif goal_type == 'endurance' %}
                            <i class="fas fa-child scale-in-center text-info me-2"></i>
                        {% else %}
                            <i class="fas fa-running scale-in-center text-primary me-2"></i>
                        {% endif %}
                        <span class="text-uppercase">{{ goal_type }}</span>
                    </h4>
                    <span class="badge bg-primary rounded-pill">{{ sessions|length }} sessions</span>
                </div>
                <div class="sessions-grid mt-3">
                    {% for session in sessions %}
                        <div class="activity-card activity-{{ session.activity_type.name|lower }}" data-session-id="{{ session.id }}">
                            <div class="activity-header">
                                <div class="activity-icon">
                                    {% if session.activity_type.name|lower == 'running' %}
                                        <i class="fas fa-running"></i>
                                    {% elif session.activity_type.name|lower == 'walking' %}
                                        <i class="fas fa-walking"></i>
                                    {% elif session.activity_type.name|lower == 'cycling' %}
                                        <i class="fas fa-biking"></i>
                                    {% elif session.activity_type.name|lower == 'swimming' %}
                                        <i class="fas fa-swimmer"></i>
                                    {% elif session.activity_type.name|lower == 'yoga' %}
                                        <i class="fas fa-pray"></i>
                                    {% elif session.activity_type.name|lower == 'gym' %}
                                        <i class="fas fa-dumbbell"></i>
                                    {% else %}
                                        <i class="fas fa-heartbeat"></i>
                                    {% endif %}
                                </div>
                                <h5 class="activity-title">{{ session.activity_type.name }}</h5>
                                <div class="completion-badge {{ 'completed' if session.is_completed else 'pending' }}">
                                    {{ 'Completed' if session.is_completed else 'Pending' }}
                                </div>
                            </div>
    
                            <div class="activity-details">
                                <div class="detail-row">
                                    <span class="detail-label"><i class="fas fa-clock text-muted me-1"></i> Duration:</span>
                                    <span class="detail-value">{{ session.duration }}</span>
                                </div>
    
                                {% set name = session.activity_type.name.lower() %}
                                {% if name in ['running', 'walking', 'cycling', 'swimming'] %}
                                    <div class="detail-row">
                                        <span class="detail-label text-light"><i class="fas fa-fire text-danger me-1"></i> Calories:</span>
                                        <span class="detail-value calories text-light">{{ session.calories_burned or 'N/A' }}</span>
                                    </div>
                                {% elif name in ['barbell squat', 'bench press', 'deadlift', 'chin-up', 'military press', 'push-up'] %}
                                    <div class="detail-row">
                                        <span class="detail-label"><i class="fas fa-layer-group text-info me-1"></i> Sets:</span>
                                        <span class="detail-value">{{ session.sets or 'N/A' }}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label"><i class="fas fa-redo text-success me-1"></i> Reps:</span>
                                        <span class="detail-value">{{ session.reps or 'N/A' }}</span>
                                    </div>
                                {% endif %}
                            </div>
    
                            <div class="activity-actions">
                                {% if not session.is_completed %}
                                    <button class="btn btn-sm btn-success complete-session-btn" data-session-id="{{ session.id }}">
                                        <i class="fas fa-check me-1"></i> Complete
                                    </button>
                                {% endif %}
                                <button class="btn btn-sm btn-info text-white edit-session-btn" data-session-id="{{ session.id }}" data-activity-name="{{ session.activity_type.name }}" data-bs-target="#editGoalModal" data-bs-toggle="modal" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-session-btn" data-session-id="{{ session.id }}" data-bs-target="#deleteGoalModal" data-bs-toggle="modal" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    {% endfor %}     
                </div>
            {% endfor %}
        {% endif %}


<!-- Goal Insights -->
<div class="row">
    <!-- Goal Distribution -->
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Goals by Activity Type</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie">
                    <canvas id="goalDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Goal Completion Rate -->
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Goal Completion History</h6>
            </div>
            <div class="card-body">
                <div class="chart-bar">
                    <canvas id="goalCompletionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Goal Modal -->
<div class="modal fade" id="createGoalModal" tabindex="-1" aria-labelledby="createGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-light" id="createGoalModalLabel">Create New Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createGoalForm">
                    <!-- Activity Type -->
                    <!-- <div class="mb-3">
                        <label for="activityType" class="form-label text-light">Activity Type</label>
                        <select class="form-select" id="activityType" required>
                            <option value="" selected disabled>Select activity type</option>
                            {% for activity_type in activity_types %}
                            <option value="{{ activity_type.id }}">{{ activity_type.name }}</option>
                            {% endfor %}
                        </select>   
                        <div class="form-text">
                            Choose the type of physical activity you plan to focus on.
                        </div>
                    </div> -->

                    <!-- Goal Type -->
                    <div class="mb-3">
                        <label for="goalType" class="form-label text-light">Goal Type</label>
                        <select class="form-select" id="goalType" required>
                            <option value="" selected disabled>Select goal type</option>
                            <option value="weightloss">Weight Loss</option>
                            <option value="weightgain">Weight Gain</option>
                            <option value="strength">Strength</option>
                            <option value="endurance">Endurance</option>
                        </select>
                        <div class="form-text">
                            What kind of outcome do you want to achieve through your training?
                        </div>
                    </div>

                    <!-- Target Value (conditionally visible) -->
                    <div class="mb-3" id="targetValueGroup" style="display: none;">
                        <label for="targetValue" class="form-label text-light">Target Value</label>
                        <input type="number" class="form-control" id="targetValue" min="1" step="0.01">
                        <div class="form-text" id="targetValueHelp">
                            Enter your target body weight (in kg or lbs) or the amount of weight to lose or gain.
                        </div>
                    </div>

                    <!-- Fitness Level -->
                    <div class="mb-3">
                        <label for="fitnessLevel" class="form-label text-light">Fitness Level</label>
                        <select class="form-select" id="fitnessLevel" required>
                            <option value="" selected disabled>Select your current fitness level</option>
                            <option value="beginner">Beginner</option>
                            <option value="novice">Novice</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                            <option value="elite">Elite</option>
                        </select>
                        <div class="form-text">
                            Helps tailor your goal based on your experience level and physical conditioning.
                        </div>
                    </div>

                    <!-- Available Time Per Week -->
                    <div class="mb-3">
                        <label for="availableTime" class="form-label text-light">Available Time Per Week (in hours)</label>
                        <input type="number" class="form-control" id="availableTime" min="1" max="168" step="0.5" required>
                        <div class="form-text">
                            How many hours can you dedicate to training per week? (Helps personalize recommendations)
                        </div>
                    </div>

                    <!-- End Date -->
                    <div class="mb-3">
                        <label for="endDate" class="form-label text-light">End Date (Optional)</label>
                        <input type="date" class="form-control" id="endDate">
                        <div class="form-text">
                            Leave empty if this is an ongoing goal with no specific end date.
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGoalBtn">Create Goal</button>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Edit Goal Modal -->
<div class="modal fade" id="editGoalModal" tabindex="-1" aria-labelledby="editGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGoalModalLabel">Edit Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGoalForm">
                    <input type="hidden" id="editGoalId">
                    <div class="mb-3" id="editRepsGroup">
                        <label for="editReps" class="form-label">Reps</label>
                        <input type="number" class="form-control" id="editReps" min="1">
                    </div>
                    <div class="mb-3" id="editSetsGroup">
                        <label for="editSets" class="form-label">Sets</label>
                        <input type="number" class="form-control" id="editSets" min="1">
                    </div>
                    <div class="mb-3" id="editTimeGroup">
                        <label for="editDuration" class="form-label">Time (minutes)</label>
                        <input type="number" class="form-control" id="editDuration" min="1">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateGoalBtn">Update Goal</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<!-- Delete Goal Confirmation Modal -->
<div class="modal fade" id="deleteGoalModal" tabindex="-1" aria-labelledby="deleteGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteGoalModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this goal? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Goal</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Global variables
    let deleteGoalId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Set up chart data if there are goals
        {% if goals %}
            setupGoalCharts();
        {% endif %}
        
        // Set up event listeners
        document.getElementById('saveGoalBtn').addEventListener('click', createGoal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteGoal);
    
        setupDeleteButtons();
    });

    document.getElementById('goalType').addEventListener('change', function () {
    const selected = this.value;
    const targetGroup = document.getElementById('targetValueGroup');
    if (selected === 'weightloss' || selected === 'weightgain') {
        targetGroup.style.display = 'block';
    } else {
        targetGroup.style.display = 'none';
    }
});

    
    document.querySelectorAll('.edit-session-btn').forEach(button => {
    button.addEventListener('click', function () {
        const sessionId = this.getAttribute('data-session-id');
        const activityName = this.getAttribute('data-activity-name')?.toLowerCase() || "";

        document.getElementById('editGoalId').value = sessionId;

       
        const cardioTypes = ['running', 'walking', 'cycling', 'swimming'];
        const strengthTypes = ['barbell squat', 'bench press', 'deadlift', 'chin-up', 'military press', 'push-up'];

       
        document.getElementById('editTimeGroup').style.display = 'none';
        document.getElementById('editRepsGroup').style.display = 'none';
        document.getElementById('editSetsGroup').style.display = 'none';

      
        if (cardioTypes.includes(activityName)) {
            document.getElementById('editTimeGroup').style.display = 'block';
        } else if (strengthTypes.includes(activityName)) {
            document.getElementById('editRepsGroup').style.display = 'block';
            document.getElementById('editSetsGroup').style.display = 'block';
        }

        
    });
});

    document.getElementById('updateGoalBtn').addEventListener('click', async () => {
    const sessionId = document.getElementById('editGoalId').value;
    const reps = document.getElementById('editRepsGroup').style.display !== 'none' 
        ? parseInt(document.getElementById('editReps').value) 
        : null;

    const sets = document.getElementById('editSetsGroup').style.display !== 'none' 
        ? parseInt(document.getElementById('editSets').value) 
        : null;

    const duration = document.getElementById('editTimeGroup').style.display !== 'none' 
        ? parseInt(document.getElementById('editDuration').value) 
        : null;

  
    const updateData = {
        session_id: sessionId,
        reps: reps,
        sets: sets,
        duration: duration
    };

    try {
        const response = await fetch('/dashboard/api/update-goal-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });

        if (response.ok) {
            const result = await response.json();
            
            alert('Goal updated successfully!');
            location.reload();  
        } else {
            const error = await response.json();
            alert(`Update failed: ${error.message}`);
        }
    } catch (err) {
        console.error('Error updating goal:', err);
        alert('An error occurred while updating the goal.');
    }
});

document.getElementById("deleteAllGoalsBtn").addEventListener("click", async () => {
    if (!confirm("Are you sure you want to delete ALL goals? This action cannot be undone!")) return;

    try {
        const response = await fetch("/dashboard/api/goals/delete_all", {
            method: "DELETE"
        });

        if (response.ok) {
            const result = await response.json();
            alert(result.message);
            window.location.reload();
        } else {
            const error = await response.json();
            alert("Error: " + error.error);
        }
    } catch (err) {
        alert("Request failed. Please try again.");
        console.error(err);
    }
});

let deleteSessionId = null;

function setupDeleteButtons() {
    const deleteButtons = document.querySelectorAll('.delete-session-btn'); 
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            deleteSessionId = this.getAttribute('data-session-id');
            console.log(deleteSessionId, "deleteSessionId")
        });
    });
}
    
    function updateGoalUI(data) {
    console.log(data, "data")
    const container = document.getElementById('sessionContainer');
    container.innerHTML = ''; 

    
    const grouped = {};

    data.sessions.forEach(session => {
        const goalType = session.goal_type?.name || 'Unknown';
        if (!grouped[goalType]) {
            grouped[goalType] = [];
        }
        grouped[goalType].push(session);
    });

    
    for (const [goalType, sessions] of Object.entries(grouped)) {
        const section = document.createElement('div');
        section.className = 'mb-4';

        const header = document.createElement('h4');
        header.textContent = `Goal Type: ${goalType}`;
        section.appendChild(header);

        const row = document.createElement('div');
        row.className = 'row';

        sessions.forEach(session => {
            const activityName = session.activity_type?.name?.toLowerCase() || '';
            const col = document.createElement('div');
            col.className = 'col-md-4';

            const card = document.createElement('div');
            card.className = 'card mb-3 shadow-sm';

            const body = document.createElement('div');
            body.className = 'card-body';

            body.innerHTML = `
                <h5 class="card-title">${session.activity_type?.name || 'Unknown'}</h5>
                <p class="card-text"><strong>Start:</strong> ${formatDateTime(session.start_time)}</p>
                <p class="card-text"><strong>End:</strong> ${session.end_time ? formatDateTime(session.end_time) : 'Ongoing'}</p>
                <p class="card-text"><strong>Completed:</strong> ${session.is_completed ? 'Yes' : 'No'}</p>
            `;

            
            const cardioTypes = ['running', 'walking', 'cycling', 'swimming'];
            const strengthTypes = [
                'barbell squat', 'bench press', 'deadlift',
                'chin-up', 'military press', 'push-up'
            ];

            if (cardioTypes.includes(activityName)) {
                body.innerHTML += `
                    <p class="card-text"><strong>Duration:</strong> ${formatDuration(session.duration)}</p>
                    <p class="card-text"><strong>Calories:</strong> ${session.calories_burned ?? 'N/A'}</p>
                `;
            } else if (strengthTypes.includes(activityName)) {
                body.innerHTML += `
                    <p class="card-text"><strong>Sets:</strong> ${session.sets ?? 'N/A'}</p>
                    <p class="card-text"><strong>Reps:</strong> ${session.reps ?? 'N/A'}</p>
                `;
            }

            card.appendChild(body);
            col.appendChild(card);
            row.appendChild(col);
        });

        section.appendChild(row);
        container.appendChild(section);
    }
}

    function formatDateTime(isoString) {
        const dt = new Date(isoString);
        return dt.toLocaleString();
    }

    function formatDuration(durationStr) {
        try {
            const duration = JSON.parse(durationStr);
            const minutes = duration?.seconds ? Math.floor(duration.seconds / 60) : 0;
            return `${minutes} minutes`;
        } catch {
            return 'N/A';
        }
    }

    async function createGoal() {
    // const activityTypeId = document.getElementById('activityType').value;
    const goalType = document.getElementById('goalType').value;
    const targetValue = document.getElementById('targetValue').value;
    const fitnessLevel = document.getElementById('fitnessLevel').value;
    const availableTime = document.getElementById('availableTime').value;
    const endDate = document.getElementById('endDate').value;

    if (!activityTypeId || !goalType || !fitnessLevel || !availableTime) {
        alert('Please fill in all required fields');
        return;
    }

    const goalData = {
        activity_type_id: parseInt(activityTypeId),
        goal_type: goalType,
        target_value: (goalType === 'weightloss' || goalType === 'weightgain') ? parseFloat(targetValue) : null,
        fitness_level: fitnessLevel,
        available_time_per_week: parseFloat(availableTime),
        end_date: endDate || null
    };
    console.log(goalData,"goalData")
    console.log(goalData.goal_type,"goalData.goal_type")

    if (goalData.goal_type === 'weightloss' && goalData.end_date) {
        const totalTargetCalories = goalData.target_value * 7700;

        const today = new Date();
        const end = new Date(goalData.end_date);

        const diffTime = end - today;
        const weeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7)) + 1;

        const maxBurnPerWeek = goalData.available_time_per_week * 700; // kcal per week
        const totalPossibleCalories = maxBurnPerWeek * weeks;

        console.log(`Target: ${totalTargetCalories}, Possible: ${totalPossibleCalories}`);

        if (totalTargetCalories > totalPossibleCalories) {
            alert("❗You can't lose that much weight within this timeline. Please reset your goal (increase available time and/or end date, or reduce target value).");
            return; // Stop execution
        }
    }
      

    try {
        const response = await fetch('/dashboard/api/create-goal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(goalData)
        });
        // const text = await response.text();  
        // console.log('Raw response:', text); 

        if (response.ok) {
            const result = await response.json();
            updateGoalUI(result);
        } else {
            const error = await response.json();
            alert(`Error creating goal: ${error.error}`);
        }
    } catch (error) {
        console.error('Error creating goal:', error);
        alert('Error creating goal. Please try again.');
    }
}
    
    
    async function deleteGoal() {
        if (!deleteSessionId) return;
        
        try {
            const response = await fetch(`/dashboard/api/sessions/${deleteSessionId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Reload the page to update the goals list
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error deleting goal: ${error.error}`);
            }
        } catch (error) {
            console.error('Error deleting goal:', error);
            alert('Error deleting goal. Please try again.');
        }
    }
    
    
</script>
{% endblock %}